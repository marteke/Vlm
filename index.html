<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Virtual VLM - Trays</title>
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; }
    body { margin: 0; background:#0b1220; color:#e8eefc; }
    header { padding:16px 18px; border-bottom:1px solid rgba(255,255,255,.08); position:sticky; top:0; background:#0b1220; z-index:10;}
    h1 { margin:0; font-size:18px; letter-spacing:.2px; }
    .wrap { max-width: 980px; margin: 0 auto; padding: 16px; }
    .grid { display:grid; grid-template-columns: 1fr; gap:12px; }
    @media (min-width: 900px){ .grid { grid-template-columns: 1.1fr .9fr; } }
    .card { background: rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.08); border-radius:14px; padding:14px; box-shadow: 0 8px 28px rgba(0,0,0,.25); }
    .row { display:flex; gap:10px; flex-wrap:wrap; align-items:center; }
    .row > * { flex: 1 1 auto; }
    label { font-size:12px; opacity:.9; display:block; margin-bottom:6px; }
    input[type="text"], input[type="number"], textarea {
      width:100%; padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.25); color:#e8eefc; outline:none;
    }
    textarea { min-height: 64px; resize: vertical; }
    input[type="file"] { width:100%; }
    button {
      padding:10px 12px; border-radius:10px; border:1px solid rgba(255,255,255,.14);
      background: rgba(76,144,255,.20); color:#e8eefc; cursor:pointer;
    }
    button:hover { background: rgba(76,144,255,.28); }
    button.danger { background: rgba(255,76,76,.18); }
    button.danger:hover { background: rgba(255,76,76,.26); }
    .hint { font-size:12px; opacity:.8; line-height:1.35; }
    .kpi { font-size:12px; opacity:.85; }
    .pill { display:inline-flex; gap:8px; align-items:center; padding:6px 10px; border-radius:999px;
            background: rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.10); }
    .viewer { display:grid; gap:12px; grid-template-columns: 1fr; }
    @media (min-width: 700px){ .viewer { grid-template-columns: 1fr 1fr; } }
    figure { margin:0; border-radius:14px; overflow:hidden; border:1px solid rgba(255,255,255,.10); background: rgba(0,0,0,.25); }
    figure img { width:100%; height: 340px; object-fit: contain; display:block; background:#060a12; }
    figcaption { padding:10px 12px; font-size:12px; opacity:.85; border-top:1px solid rgba(255,255,255,.08); }
    .mono { font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace; }
    .small { font-size: 12px; opacity:.85; }
    .list { margin-top:10px; max-height: 240px; overflow:auto; border-radius: 12px; border:1px solid rgba(255,255,255,.10);}
    .list-item { display:flex; justify-content:space-between; gap:10px; padding:10px 12px; border-bottom:1px solid rgba(255,255,255,.06); }
    .list-item:last-child { border-bottom:none; }
    .list-item button { flex:0 0 auto; padding:6px 10px; }
    .toast { margin-top:10px; padding:10px 12px; border-radius:12px; background: rgba(0,0,0,.25); border:1px solid rgba(255,255,255,.10); }
  
    /* Zoom modal */
    .zoom-modal{
      position:fixed; inset:0; display:none; align-items:center; justify-content:center;
      background: rgba(0,0,0,.82); z-index:9999; padding: 14px;
    }
    .zoom-modal.open{ display:flex; }
    .zoom-modal img{
      max-width: 95vw; max-height: 85vh; object-fit: contain;
      border-radius: 14px; border:1px solid rgba(255,255,255,.12);
      background:#05070d;
    }
    .zoom-close{
      position: fixed; top: 14px; right: 14px;
      padding: 10px 12px; border-radius: 12px;
      background: rgba(255,255,255,.12);
      border:1px solid rgba(255,255,255,.18);
    }
    .zoom-caption{
      position: fixed; bottom: 14px; left: 14px; right: 14px;
      padding: 10px 12px; border-radius: 12px;
      background: rgba(0,0,0,.35); border:1px solid rgba(255,255,255,.12);
      font-size: 12px; opacity: .92;
      text-align:center;
    }
    figure img{ cursor: zoom-in; }
    
  </style>
</head>
<body>
<header>
  <div class="wrap row" style="align-items:flex-end">
    <div style="flex: 2 1 420px;">
      <h1>Virtual VLM — Trays (2 photos per tray)</h1>
      <div class="small">Runs offline. Saves photos in your browser (IndexedDB).</div>
    </div>
    <div class="row" style="justify-content:flex-end; gap:8px; flex: 1 1 320px;">
      <button id="btnExport">Export backup (.json)</button>
      <button id="btnImport">Import backup</button>
      <input id="importFile" type="file" accept="application/json" hidden />
    </div>
  </div>
</header>

<main class="wrap">
  <div class="grid">

    <section class="card">
      <h2 style="margin:0 0 10px 0; font-size:16px;">Find tray</h2>
      <div class="row">
        <div style="flex:2 1 320px;">
          <label>Tray number</label>
          <input id="searchTray" type="text" placeholder="e.g., 102 or TR-102" />
        </div>
        <div style="flex:1 1 160px;">
          <label>&nbsp;</label>
          <button id="btnFind">Show</button>
        </div>
      </div>
      <div class="row" style="margin-top:10px;">
        <div class="pill kpi"><span>Trays saved:</span> <b id="countTrays">0</b></div>
        <div class="pill kpi"><span>Status:</span> <span id="status" class="mono">OK</span></div>
      </div>

      <div id="viewerArea" style="margin-top:14px; display:none;">
        <div class="row" style="align-items:flex-start;">
          <div style="flex:2 1 380px;">
            <div class="pill"><b>Tray:</b> <span id="viewTray" class="mono"></span></div>
          </div>
          <div class="row" style="flex:1 1 260px; justify-content:flex-end;">
            <button id="btnLoadToEdit">Edit this tray</button>
            <button id="btnDeleteTray" class="danger">Delete</button>
          </div>
        </div>
        <div class="viewer" style="margin-top:12px;">
          <figure>
            <img id="img1" alt="Photo 1" />
            <figcaption id="cap1">Photo 1</figcaption>
          </figure>
          <figure>
            <img id="img2" alt="Photo 2" />
            <figcaption id="cap2">Photo 2</figcaption>
          </figure>
        </div>

        <!-- Zoom modal -->
        <div id="zoomModal" class="zoom-modal" aria-hidden="true">
          <button id="zoomClose" class="zoom-close" title="Close">✕</button>
          <img id="zoomImg" alt="Zoom" />
          <div id="zoomCaption" class="zoom-caption"></div>
        </div>

        <div class="toast" style="margin-top:12px;">
          <div style="font-weight:600; margin-bottom:6px;">Notes (optional)</div>
          <div id="viewNotes" class="small" style="white-space:pre-wrap;"></div>
          <div class="small" style="margin-top:8px; opacity:.75;">
            Last updated: <span id="viewUpdated" class="mono"></span>
          </div>
        </div>
      </div>

      <div class="list">
        <div class="list-item" style="opacity:.85;">
          <div><b>Quick list</b> (click to open)</div>
          <div class="mono">#</div>
        </div>
        <div id="trayList"></div>
      </div>

      <div class="hint" style="margin-top:10px;">
        Tip: you can type “102”, “TR-102”, “tray 102”… the app normalizes and searches by the number/text.
      </div>
    </section>

    <section class="card">
      <h2 style="margin:0 0 10px 0; font-size:16px;">Add / Update tray</h2>

      <div class="row">
        <div style="flex: 1 1 220px;">
          <label>Tray number</label>
          <input id="editTray" type="text" placeholder="e.g., 102" />
        </div>
        <div style="flex: 1 1 220px;">
          <label>Label (optional)</label>
          <input id="editLabel" type="text" placeholder="e.g., Aisle 3 / Rack B" />
        </div>
      </div>

      <div style="margin-top:10px;">
        <label>Photo 1 (e.g., front view)</label>
        <input id="file1" type="file" accept="image/*" />
      </div>
      <div style="margin-top:10px;">
        <label>Photo 2 (e.g., top view)</label>
        <input id="file2" type="file" accept="image/*" />
      </div>

      <div style="margin-top:10px;">
        <label>Notes (optional)</label>
        <textarea id="editNotes" placeholder="e.g., connectors, cables, special labels..."></textarea>
      </div>

      <div class="row" style="margin-top:12px;">
        <button id="btnSave" style="flex:1 1 200px;">Save tray</button>
        <button id="btnClear" style="flex:1 1 200px;">Clear</button>
      </div>

      <div class="hint" style="margin-top:10px;">
        Important: photos are saved in this device’s browser. To use the same data on PC and iPhone, use <b>Export</b> and <b>Import</b>.
      </div>
    </section>

  </div>
</main>

<script>
  // ---------- Helpers ----------
  const $ = (id) => document.getElementById(id);
  const normKey = (s) => (s || "").trim().toLowerCase();
  const nowISO = () => new Date().toISOString();

  function extractTrayId(input) {
    // Mantém texto, mas também tenta extrair número principal
    const raw = (input || "").trim();
    if (!raw) return "";
    const m = raw.match(/(\d{1,6})/);
    if (m) return m[1]; // usa o número como chave principal
    return raw.replace(/\s+/g, "-").slice(0, 40);
  }

  function setStatus(msg) { $("status").textContent = msg; }

  function download(filename, text) {
    const a = document.createElement("a");
    a.href = URL.createObjectURL(new Blob([text], {type:"application/json"}));
    a.download = filename;
    a.click();
    URL.revokeObjectURL(a.href);
  }

  // ---------- IndexedDB ----------
  const DB_NAME = "vlm_virtual_trays";
  const DB_VER  = 1;
  const STORE   = "trays";

  function openDB() {
    return new Promise((resolve, reject) => {
      const req = indexedDB.open(DB_NAME, DB_VER);
      req.onupgradeneeded = () => {
        const db = req.result;
        if (!db.objectStoreNames.contains(STORE)) {
          db.createObjectStore(STORE, { keyPath: "trayId" });
        }
      };
      req.onsuccess = () => resolve(req.result);
      req.onerror = () => reject(req.error);
    });
  }

  async function putTray(tray) {
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(STORE, "readwrite");
      tx.objectStore(STORE).put(tray);
      tx.oncomplete = () => resolve(true);
      tx.onerror = () => reject(tx.error);
    });
  }

  async function getTray(trayId) {
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(STORE, "readonly");
      const req = tx.objectStore(STORE).get(trayId);
      req.onsuccess = () => resolve(req.result || null);
      req.onerror = () => reject(req.error);
    });
  }

  async function deleteTray(trayId) {
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(STORE, "readwrite");
      tx.objectStore(STORE).delete(trayId);
      tx.oncomplete = () => resolve(true);
      tx.onerror = () => reject(tx.error);
    });
  }

  async function getAllTrays() {
    const db = await openDB();
    return new Promise((resolve, reject) => {
      const tx = db.transaction(STORE, "readonly");
      const req = tx.objectStore(STORE).getAll();
      req.onsuccess = () => resolve(req.result || []);
      req.onerror = () => reject(req.error);
    });
  }

  async function readImageFile(file) {
    // iOS compatibility: store as a plain Blob (not File) to avoid IndexedDB issues on some Safari builds
    if (!file) return null;
    const buf = await file.arrayBuffer();
    const blob = new Blob([buf], { type: file.type || "image/jpeg" });
    return { name: file.name || "photo.jpg", type: blob.type, blob };
  }

  function blobToObjectURL(blob) {
    return URL.createObjectURL(blob);
  }

  // ---------- UI ----------
  let currentView = null;
  let objectUrls = [];

  function clearObjectURLs() {
    objectUrls.forEach(u => URL.revokeObjectURL(u));
    objectUrls = [];
  }

  async function refreshList() {
    const all = await getAllTrays();
    $("countTrays").textContent = all.length;

    // Ordena por trayId "numérico" quando possível
    all.sort((a,b) => {
      const an = parseInt(a.trayId,10), bn = parseInt(b.trayId,10);
      if (!isNaN(an) && !isNaN(bn)) return an - bn;
      return (a.trayId||"").localeCompare(b.trayId||"");
    });

    const list = $("trayList");
    list.innerHTML = "";
    for (const t of all) {
      const div = document.createElement("div");
      div.className = "list-item";
      const left = document.createElement("div");
      left.innerHTML = `<div><b class="mono">${t.trayId}</b> ${t.label ? "— " + t.label : ""}</div>
                        <div class="small" style="opacity:.75;">${t.updatedAt ? t.updatedAt : ""}</div>`;
      const btn = document.createElement("button");
      btn.textContent = "Abrir";
      btn.onclick = () => { $("searchTray").value = t.trayId; showTrayByInput(); };
      div.appendChild(left);
      div.appendChild(btn);
      list.appendChild(div);
    }
  }

  async function showTray(tray) {
    clearObjectURLs();
    currentView = tray;
    $("viewerArea").style.display = "block";
    $("viewTray").textContent = tray.trayId + (tray.label ? ` (${tray.label})` : "");
    $("viewNotes").textContent = tray.notes || "";
    $("viewUpdated").textContent = tray.updatedAt || "";

    const p1 = tray.photos?.[0]?.blob || null;
    const p2 = tray.photos?.[1]?.blob || null;

    if (p1) {
      const u1 = blobToObjectURL(p1);
      objectUrls.push(u1);
      $("img1").src = u1;
      $("cap1").textContent = tray.photos?.[0]?.name ? `Photo 1 — ${tray.photos[0].name}` : "Photo 1";
    } else {
      $("img1").removeAttribute("src");
      $("cap1").textContent = "Photo 1 — (não cadastrada)";
    }

    if (p2) {
      const u2 = blobToObjectURL(p2);
      objectUrls.push(u2);
      $("img2").src = u2;
      $("cap2").textContent = tray.photos?.[1]?.name ? `Photo 2 — ${tray.photos[1].name}` : "Photo 2";
    } else {
      $("img2").removeAttribute("src");
      $("cap2").textContent = "Photo 2 — (não cadastrada)";
    }
  }

  async function showTrayByInput() {
    const input = $("searchTray").value;
    const trayId = extractTrayId(input);
    if (!trayId) { setStatus("Type a tray number"); return; }

    const tray = await getTray(trayId);
    if (!tray) {
      $("viewerArea").style.display = "none";
      setStatus(`Not found: ${trayId}`);
      return;
    }
    setStatus("OK");
    await showTray(tray);
  }

  function fillEditorFromTray(tray) {
    $("editTray").value = tray.trayId || "";
    $("editLabel").value = tray.label || "";
    $("editNotes").value = tray.notes || "";
    // não preenche inputs file (por segurança do browser)
    $("file1").value = "";
    $("file2").value = "";
    setStatus("Editor loaded (attach new photos to replace)");
  }

  function clearEditor() {
    $("editTray").value = "";
    $("editLabel").value = "";
    $("editNotes").value = "";
    $("file1").value = "";
    $("file2").value = "";
  }

  // ---------- Actions ----------
  $("btnFind").onclick = showTrayByInput;
  $("searchTray").addEventListener("keydown", (e) => { if (e.key === "Enter") showTrayByInput(); });

  $("btnSave").onclick = async () => {
    try {
      const trayId = extractTrayId($("editTray").value);
      if (!trayId) { setStatus("Enter the tray number"); return; }

      const existing = await getTray(trayId);
      const label = $("editLabel").value.trim();
      const notes = $("editNotes").value;

      const f1 = $("file1").files?.[0] || null;
      const f2 = $("file2").files?.[0] || null;

      const img1 = await readImageFile(f1);
      const img2 = await readImageFile(f2);

      const photos = [
        img1 || existing?.photos?.[0] || null,
        img2 || existing?.photos?.[1] || null
      ].filter(x => true); // keep positions (may be null)

      const tray = {
        trayId,
        label,
        notes,
        photos,
        updatedAt: nowISO()
      };

      await putTray(tray);
      setStatus(`Saved: ${trayId}`);
      await refreshList();
    } catch (err) {
      console.error(err);
      // Common iPhone causes: Private Browsing, blocked storage, or opening as a local file (file://)
      setStatus("Save failed on this iPhone browser. Try: disable Private Browsing, allow cookies, and open the page via http(s) (not file://).");
    }
  };

    await putTray(tray);
    setStatus(`Saved: ${trayId}`);
    await refreshList();
  };

  $("btnClear").onclick = () => { clearEditor(); setStatus("OK"); };

  $("btnDeleteTray").onclick = async () => {
    if (!currentView?.trayId) return;
    const trayId = currentView.trayId;
    const ok = confirm(`Delete o tray ${trayId}?`);
    if (!ok) return;
    await deleteTray(trayId);
    $("viewerArea").style.display = "none";
    currentView = null;
    clearObjectURLs();
    setStatus(`Deleted: ${trayId}`);
    await refreshList();
  };

  $("btnLoadToEdit").onclick = () => {
    if (!currentView) return;
    fillEditorFromTray(currentView);
  };

  // Backup: exporta tudo (inclui as fotos em base64 dentro do JSON)
  // Observação: pode ficar grande dependendo da quantidade de fotos.
  async function exportBackup() {
    const all = await getAllTrays();
    // converte blobs para base64 para caber em JSON
    async function blobToDataURL(blob) {
      return new Promise((resolve, reject) => {
        if (!blob) return resolve(null);
        const r = new FileReader();
        r.onload = () => resolve(r.result);
        r.onerror = () => reject(r.error);
        r.readAsDataURL(blob);
      });
    }

    const payload = [];
    for (const t of all) {
      const p = [];
      for (const ph of (t.photos || [])) {
        if (ph?.blob) {
          const dataUrl = await blobToDataURL(ph.blob);
          p.push({ name: ph.name, type: ph.type, dataUrl });
        } else {
          p.push(null);
        }
      }
      payload.push({
        trayId: t.trayId,
        label: t.label || "",
        notes: t.notes || "",
        updatedAt: t.updatedAt || "",
        photos: p
      });
    }

    const backup = {
      app: "VLM Virtual Trays",
      exportedAt: nowISO(),
      trays: payload
    };

    download(`vlm_trays_backup_${new Date().toISOString().slice(0,10)}.json`, JSON.stringify(backup));
    setStatus("Backup exported");
  }

  async function importBackup(file) {
    const text = await file.text();
    const data = JSON.parse(text);
    const trays = data?.trays || [];
    let count = 0;

    function dataURLToBlob(dataUrl) {
      if (!dataUrl) return null;
      const [meta, b64] = dataUrl.split(",");
      const mime = (meta.match(/data:(.*?);base64/) || [])[1] || "application/octet-stream";
      const bin = atob(b64);
      const u8 = new Uint8Array(bin.length);
      for (let i=0; i<bin.length; i++) u8[i] = bin.charCodeAt(i);
      return new Blob([u8], { type: mime });
    }

    for (const t of trays) {
      const photos = (t.photos || []).map(ph => {
        if (!ph) return null;
        const blob = dataURLToBlob(ph.dataUrl);
        return { name: ph.name || "foto", type: ph.type || blob?.type || "image/jpeg", blob };
      });

      await putTray({
        trayId: t.trayId,
        label: t.label || "",
        notes: t.notes || "",
        updatedAt: t.updatedAt || nowISO(),
        photos
      });
      count++;
    }

    setStatus(`Imported: ${count} trays`);
    await refreshList();
  }

  $("btnExport").onclick = exportBackup;
  $("btnImport").onclick = () => $("importFile").click();
  $("importFile").onchange = async (e) => {
    const f = e.target.files?.[0];
    if (!f) return;
    try {
      await importBackup(f);
    } catch (err) {
      console.error(err);
      setStatus("Import failed (invalid file?)");
    } finally {
      e.target.value = "";
    }
  };


  // --- Zoom / Fullscreen preview ---
  function openZoom(src, caption){
    if (!src) return;
    $("zoomImg").src = src;
    $("zoomCaption").textContent = caption || "";
    $("zoomModal").classList.add("open");
    $("zoomModal").setAttribute("aria-hidden","false");
    document.body.style.overflow = "hidden";
  }
  function closeZoom(){
    $("zoomModal").classList.remove("open");
    $("zoomModal").setAttribute("aria-hidden","true");
    $("zoomImg").removeAttribute("src");
    document.body.style.overflow = "";
  }

  document.addEventListener("DOMContentLoaded", () => {
    $("zoomClose").onclick = closeZoom;

    $("img1").addEventListener("click", () => openZoom($("img1").src, $("cap1").textContent));
    $("img2").addEventListener("click", () => openZoom($("img2").src, $("cap2").textContent));

    $("zoomModal").addEventListener("click", (e) => {
      if (e.target === $("zoomModal")) closeZoom();
    });

    document.addEventListener("keydown", (ev) => {
      if (ev.key === "Escape") closeZoom();
    });
  });

  // init
  (async function init(){
    try {
      await refreshList();
      setStatus("OK");
    } catch (e) {
      console.error(e);
      setStatus("Error opening database");
    }
  })();
</script>
</body>
</html>
