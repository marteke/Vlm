<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Virtual VLM — Trays (2 photos per tray)</title>

  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#0b1220">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="VLM">
  <link rel="apple-touch-icon" href="icon-192.png">

  <style>
    :root{
      --bg:#0b1220; --card:#121b2f; --card2:#0f172a; --txt:#e5e7eb; --muted:#a1a1aa;
      --line:rgba(255,255,255,.12); --btn:#1f2a44; --btn2:#253255; --ok:#16a34a; --bad:#ef4444;
      --accent:#22c55e;
    }
    *{box-sizing:border-box}
    body{
      margin:0; font-family: -apple-system,system-ui,Segoe UI,Roboto,Arial;
      background:linear-gradient(180deg,var(--bg),#070b14);
      color:var(--txt);
      padding:16px 14px 40px;
    }
    h1{font-size:20px;margin:4px 0 2px}
    .sub{color:var(--muted); font-size:13px; margin-bottom:12px}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .btn{
      border:1px solid var(--line);
      background:linear-gradient(180deg,var(--btn),var(--btn2));
      color:var(--txt);
      padding:10px 12px;
      border-radius:12px;
      font-size:14px;
      cursor:pointer;
    }
    .btn:active{transform:translateY(1px)}
    .card{
      margin-top:14px;
      background:rgba(18,27,47,.85);
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px;
      backdrop-filter: blur(8px);
    }
    .card h2{margin:0 0 10px; font-size:16px}
    label{display:block; font-size:13px; color:var(--muted); margin:10px 0 6px}
    input, textarea{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(15,23,42,.65);
      color:var(--txt);
      outline:none;
      font-size:15px;
    }
    textarea{min-height:76px; resize:vertical}
    .mini{font-size:12px;color:var(--muted);margin-top:8px}
    .statusbar{display:flex; gap:10px; align-items:center; margin-top:10px; flex-wrap:wrap}
    .pill{
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(15,23,42,.55);
      color:var(--muted);
      font-size:13px;
    }
    .pill.ok{color:#bbf7d0;border-color:rgba(34,197,94,.35)}
    .pill.bad{color:#fecaca;border-color:rgba(239,68,68,.35)}
    details{margin-top:10px}
    summary{cursor:pointer; color:var(--txt)}
    table{width:100%; border-collapse:collapse; margin-top:10px}
    th,td{border-bottom:1px solid rgba(255,255,255,.08); padding:8px 6px; font-size:14px}
    td a{color:#93c5fd}
    .thumbs{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    .thumb{
      width:min(260px,48%);
      border:1px solid rgba(255,255,255,.14);
      border-radius:14px;
      overflow:hidden;
      background:#081022;
    }
    .thumb img{width:100%; display:block}
    .thumb .cap{padding:8px 10px; font-size:12px; color:var(--muted)}
    .grid2{display:grid; grid-template-columns:1fr; gap:10px}
    @media (min-width:720px){ .grid2{grid-template-columns:1fr 1fr} }
    .noteBox{
      border:1px dashed rgba(255,255,255,.22);
      background:rgba(2,6,23,.35);
      border-radius:14px;
      padding:12px;
      color:var(--muted);
      font-size:13px;
      line-height:1.35;
    }
    .zoom{
      position:fixed; inset:0; background:rgba(0,0,0,.82);
      display:none; align-items:center; justify-content:center; padding:18px;
      z-index:9999;
    }
    .zoom img{max-width:100%; max-height:100%; border-radius:14px; border:1px solid rgba(255,255,255,.18)}
    .zoom .close{
      position:fixed; top:14px; right:14px;
      width:42px; height:42px; border-radius:999px;
      border:1px solid rgba(255,255,255,.22);
      background:rgba(15,23,42,.75);
      color:var(--txt); font-size:22px; line-height:40px; text-align:center;
      cursor:pointer;
    }
    .kbd{font-family:ui-monospace,SFMono-Regular,Menlo,monospace; padding:2px 6px; border:1px solid rgba(255,255,255,.18); border-radius:6px; background:rgba(255,255,255,.06)}
  </style>
</head>
<body>
  <h1>Virtual VLM — Trays (2 photos per tray)</h1>
  <div class="sub">
    Hybrid mode (iPhone-friendly): stores <b>preview images + tray data</b> in the app, while your <b>original photos stay in your iPhone Photos</b>.
    Use the caption trick below to find originals instantly.
  </div>

  <div class="row">
    <button class="btn" id="exportBtn">Export backup (.json)</button>
    <button class="btn" id="importBtn">Import backup</button>
    <input type="file" id="importFile" accept="application/json" style="display:none" />
    <button class="btn" id="clearBtn" title="Deletes all trays from this device">Clear all (this device)</button>
  </div>

  <div class="card">
    <h2>Find tray</h2>
    <label for="q">Tray number</label>
    <input id="q" placeholder='e.g., 102 or TR-102' />
    <div class="row" style="margin-top:10px">
      <button class="btn" id="showBtn">Show</button>
      <button class="btn" id="copySearchBtn" title="Copies a Photos search keyword like: TRAY 102">Copy Photos search keyword</button>
    </div>
    <div class="statusbar">
      <div class="pill" id="countPill">Trays saved: 0</div>
      <div class="pill ok" id="statusPill">Status: OK</div>
    </div>

    <details>
      <summary><b>Quick list</b> (click to open)</summary>
      <div id="listWrap"></div>
    </details>

    <div id="viewer" style="margin-top:12px"></div>
  </div>

  <div class="card">
    <h2>Add / Update tray</h2>

    <div class="noteBox">
      <b>Best iPhone workflow (no cloud):</b><br>
      1) Take your photos as usual.<br>
      2) In the Photos app, add a <b>Caption</b> like: <span class="kbd">TRAY 25</span> (or <span class="kbd">TRAY 25 TOP</span>).<br>
      3) Here, save the tray with previews. Later, you can search Photos for <span class="kbd">TRAY 25</span> to open the <b>original</b> photos (full resolution).<br><br>
      Tip: you can press <b>Copy Photos search keyword</b> to copy <span class="kbd">TRAY &lt;number&gt;</span>.
    </div>

    <label for="tray">Tray number</label>
    <input id="tray" placeholder="e.g., 25 or TR-25" />

    <label for="label">Label (optional)</label>
    <input id="label" placeholder="e.g., Aisle 3 / Rack B" />

    <div class="grid2">
      <div>
        <label>Photo 1 preview (front view)</label>
        <input type="file" id="p1" accept="image/*" />
        <div class="mini">Saves a preview inside the app (optimized for iPhone storage).</div>
      </div>
      <div>
        <label>Photo 2 preview (top view)</label>
        <input type="file" id="p2" accept="image/*" />
        <div class="mini">Originals stay in your Photos; add caption like <span class="kbd">TRAY 25</span>.</div>
      </div>
    </div>

    <label for="notes">Notes (optional)</label>
    <textarea id="notes" placeholder="e.g., connectors, cables, special labels..."></textarea>

    <div class="row" style="margin-top:10px">
      <button class="btn" id="saveBtn">Save tray</button>
      <button class="btn" id="deleteBtn">Delete tray</button>
      <button class="btn" id="copyCaptionBtn" title="Copies a caption template like: TRAY 25">Copy caption template</button>
    </div>

    <div class="mini" id="saveHint"></div>
  </div>

  <div class="zoom" id="zoom">
    <div class="close" id="zoomClose">×</div>
    <img id="zoomImg" alt="Zoomed preview" />
  </div>

<script>
/* -----------------------------
   Storage (iPhone-friendly):
   - Uses localStorage only
   - Stores metadata + small previews
------------------------------*/
const KEY = "vlm_trays_v2_localphotos";
function loadAll(){
  try { return JSON.parse(localStorage.getItem(KEY) || "{}"); }
  catch(e){ return {}; }
}
function saveAll(obj){
  localStorage.setItem(KEY, JSON.stringify(obj));
}
function normalizeTray(s){
  return (s||"").toString().trim().toUpperCase().replace(/\s+/g," ");
}
function trayNumberOnly(s){
  // Extract digits from "TR-102", "tray 102", etc.
  const m = (s||"").toString().match(/(\d+)/g);
  return m ? m.join("") : "";
}
function makeSearchKeyword(tray){
  const n = trayNumberOnly(tray);
  return n ? `TRAY ${n}` : (normalizeTray(tray) || "");
}
function setStatus(ok, msg){
  const pill = document.getElementById("statusPill");
  pill.textContent = "Status: " + (msg || (ok?"OK":"ERROR"));
  pill.classList.toggle("ok", !!ok);
  pill.classList.toggle("bad", !ok);
}

/* -----------------------------
   Image preview compressor
   - converts to JPEG dataURL
------------------------------*/
async function fileToPreviewDataURL(file, maxSide=1400, quality=0.78){
  if(!file) return null;
  const img = await createImageBitmap(file);
  let w = img.width, h = img.height;
  const scale = Math.min(1, maxSide / Math.max(w,h));
  const nw = Math.max(1, Math.round(w*scale));
  const nh = Math.max(1, Math.round(h*scale));

  const canvas = document.createElement("canvas");
  canvas.width = nw; canvas.height = nh;
  const ctx = canvas.getContext("2d");
  ctx.drawImage(img, 0, 0, nw, nh);

  // JPEG reduces size vs PNG (critical for iPhone)
  const dataUrl = canvas.toDataURL("image/jpeg", quality);
  return { dataUrl, w:nw, h:nh, mime:"image/jpeg" };
}

function updateCount(){
  const all = loadAll();
  const count = Object.keys(all).length;
  document.getElementById("countPill").textContent = `Trays saved: ${count}`;
}
function renderList(){
  const all = loadAll();
  const keys = Object.keys(all).sort((a,b)=>a.localeCompare(b, undefined, {numeric:true}));
  const wrap = document.getElementById("listWrap");
  if(keys.length===0){ wrap.innerHTML = `<div class="mini">No trays saved yet.</div>`; return; }
  let html = `<table><thead><tr><th>Tray</th><th>Label</th><th>Updated</th></tr></thead><tbody>`;
  for(const k of keys){
    const t = all[k];
    html += `<tr>
      <td><a href="#" data-tray="${encodeURIComponent(k)}">${k}</a></td>
      <td>${escapeHtml(t.label||"")}</td>
      <td>${new Date(t.updatedAt||0).toLocaleString()}</td>
    </tr>`;
  }
  html += `</tbody></table>`;
  wrap.innerHTML = html;
  wrap.querySelectorAll("a[data-tray]").forEach(a=>{
    a.addEventListener("click",(e)=>{
      e.preventDefault();
      const tray = decodeURIComponent(a.getAttribute("data-tray"));
      document.getElementById("q").value = tray;
      showTray(tray);
    });
  });
}

function escapeHtml(s){
  return (s||"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
}

function zoomImage(src){
  const z = document.getElementById("zoom");
  const zi = document.getElementById("zoomImg");
  zi.src = src;
  z.style.display = "flex";
}
function closeZoom(){
  document.getElementById("zoom").style.display = "none";
  document.getElementById("zoomImg").src = "";
}
document.getElementById("zoomClose").addEventListener("click", closeZoom);
document.getElementById("zoom").addEventListener("click",(e)=>{ if(e.target.id==="zoom") closeZoom(); });
document.addEventListener("keydown",(e)=>{ if(e.key==="Escape") closeZoom(); });

function showTray(trayRaw){
  const tray = normalizeTray(trayRaw);
  const all = loadAll();
  const t = all[tray];
  const viewer = document.getElementById("viewer");
  if(!tray){ viewer.innerHTML = ""; return; }
  if(!t){
    viewer.innerHTML = `<div class="mini">Tray <b>${escapeHtml(tray)}</b> not found.</div>`;
    return;
  }
  const searchKey = makeSearchKeyword(tray);
  viewer.innerHTML = `
    <div class="noteBox" style="margin-bottom:10px">
      <b>Open originals in Photos:</b> search for <span class="kbd">${escapeHtml(searchKey)}</span> (because you added captions in Photos).
    </div>
    <div class="thumbs">
      ${t.p1?.dataUrl ? `<div class="thumb"><img src="${t.p1.dataUrl}" alt="Photo 1 preview"><div class="cap">Photo 1 preview (tap to zoom)</div></div>` : ``}
      ${t.p2?.dataUrl ? `<div class="thumb"><img src="${t.p2.dataUrl}" alt="Photo 2 preview"><div class="cap">Photo 2 preview (tap to zoom)</div></div>` : ``}
    </div>
    <div class="mini" style="margin-top:10px"><b>Label:</b> ${escapeHtml(t.label||"-")}</div>
    <div class="mini"><b>Notes:</b> ${escapeHtml(t.notes||"-")}</div>
    <div class="row" style="margin-top:10px">
      <button class="btn" id="copyKeyBtn">Copy Photos keyword</button>
      <button class="btn" id="loadToFormBtn">Load into form</button>
    </div>
  `;
  viewer.querySelectorAll(".thumb img").forEach(img=>{
    img.style.cursor="zoom-in";
    img.addEventListener("click",()=>zoomImage(img.src));
  });
  viewer.querySelector("#copyKeyBtn").addEventListener("click", async ()=>{
    await copyText(searchKey);
    setStatus(true, `Copied: ${searchKey}`);
  });
  viewer.querySelector("#loadToFormBtn").addEventListener("click", ()=>{
    document.getElementById("tray").value = tray;
    document.getElementById("label").value = t.label||"";
    document.getElementById("notes").value = t.notes||"";
    document.getElementById("saveHint").textContent = "Loaded tray data into form (previews are already saved).";
    setStatus(true,"OK");
    window.scrollTo({top:document.body.scrollHeight, behavior:"smooth"});
  });
}

async function copyText(text){
  try{
    await navigator.clipboard.writeText(text);
  }catch(e){
    const ta = document.createElement("textarea");
    ta.value = text;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand("copy");
    ta.remove();
  }
}

/* -----------------------------
   Buttons
------------------------------*/
document.getElementById("showBtn").addEventListener("click",()=>{
  showTray(document.getElementById("q").value);
});
document.getElementById("q").addEventListener("keydown",(e)=>{
  if(e.key==="Enter") showTray(e.target.value);
});
document.getElementById("copySearchBtn").addEventListener("click", async ()=>{
  const q = document.getElementById("q").value;
  const key = makeSearchKeyword(q);
  if(!key){ setStatus(false,"Type a tray number first"); return; }
  await copyText(key);
  setStatus(true, `Copied: ${key}`);
});

document.getElementById("copyCaptionBtn").addEventListener("click", async ()=>{
  const tray = document.getElementById("tray").value;
  const key = makeSearchKeyword(tray);
  if(!key){ setStatus(false,"Type a tray number first"); return; }
  await copyText(key);
  document.getElementById("saveHint").textContent = `Caption copied. In Photos: open photo → swipe up → Add a Caption → paste: ${key}`;
  setStatus(true, "OK");
});

document.getElementById("saveBtn").addEventListener("click", async ()=>{
  const trayRaw = document.getElementById("tray").value;
  const tray = normalizeTray(trayRaw);
  if(!tray){ setStatus(false,"Tray number is required"); return; }

  const all = loadAll();
  const existing = all[tray] || {};

  // Build record
  const rec = {
    tray,
    label: document.getElementById("label").value || "",
    notes: document.getElementById("notes").value || "",
    updatedAt: Date.now(),
    // Keep existing previews if user doesn't reselect files
    p1: existing.p1 || null,
    p2: existing.p2 || null,
  };

  try{
    const f1 = document.getElementById("p1").files[0];
    const f2 = document.getElementById("p2").files[0];
    if(f1) rec.p1 = await fileToPreviewDataURL(f1, 1400, 0.78);
    if(f2) rec.p2 = await fileToPreviewDataURL(f2, 1400, 0.78);

    all[tray] = rec;
    // Attempt save
    saveAll(all);

    // Verify write by reading back
    const check = loadAll();
    if(!check[tray]) throw new Error("Write verification failed");

    document.getElementById("saveHint").textContent =
      `Saved. Tip: add Photos captions like "${makeSearchKeyword(tray)}" to find originals quickly.`;
    setStatus(true,"OK");
    updateCount();
    renderList();
    // clear file inputs (keep previews saved)
    document.getElementById("p1").value="";
    document.getElementById("p2").value="";
  }catch(e){
    console.error(e);
    setStatus(false,"Save failed (iPhone storage). Use Export backup or reduce previews.");
    document.getElementById("saveHint").textContent =
      "Save failed. Try: (1) add fewer trays on this device, (2) use smaller photos, (3) rely on Export/Import backup.";
  }
});

document.getElementById("deleteBtn").addEventListener("click",()=>{
  const tray = normalizeTray(document.getElementById("tray").value);
  if(!tray){ setStatus(false,"Type tray number"); return; }
  const all = loadAll();
  if(!all[tray]){ setStatus(false,"Tray not found"); return; }
  delete all[tray];
  saveAll(all);
  setStatus(true,"Deleted");
  updateCount();
  renderList();
});

document.getElementById("exportBtn").addEventListener("click",()=>{
  const all = loadAll();
  const blob = new Blob([JSON.stringify(all, null, 2)], {type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `vlm_backup_${new Date().toISOString().slice(0,10)}.json`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
  setStatus(true,"Backup exported");
});

document.getElementById("importBtn").addEventListener("click",()=>{
  document.getElementById("importFile").click();
});
document.getElementById("importFile").addEventListener("change", async (e)=>{
  const file = e.target.files[0];
  if(!file) return;
  try{
    const text = await file.text();
    const obj = JSON.parse(text);
    if(typeof obj !== "object" || obj === null) throw new Error("Invalid JSON");
    saveAll(obj);
    setStatus(true,"Backup imported");
    updateCount();
    renderList();
  }catch(err){
    console.error(err);
    setStatus(false,"Import failed");
  }finally{
    e.target.value="";
  }
});

document.getElementById("clearBtn").addEventListener("click",()=>{
  if(!confirm("Delete ALL trays from this device?")) return;
  localStorage.removeItem(KEY);
  setStatus(true,"Cleared");
  updateCount();
  renderList();
  document.getElementById("viewer").innerHTML="";
});

/* Init */
updateCount();
renderList();
setStatus(true,"OK");

/* PWA / SW */
if("serviceWorker" in navigator){
  window.addEventListener("load", ()=>{
    navigator.serviceWorker.register("./sw.js").catch(()=>{});
  });
}
</script>
</body>
</html>
